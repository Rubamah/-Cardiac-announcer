<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cardiac Announcer</title>
<style>
  body {
    background: #f5f7fb;
    font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color: #0f172a;
    text-align: center;
    margin: 0;
  }
  #call {
    display: none;
    width: min(960px, 94vw);
    margin: 40px auto;
    background: #000;
    color: #fff;
    border-radius: 16px;
    padding: 32px 18px;
    font-weight: 800;
    font-size: clamp(26px, 4.5vw, 40px);
    line-height: 1.6;
  }
  #call b { font-weight: 800; }
  #soundGate {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, .75);
    color: #fff;
    z-index: 10;
    font-size: 22px;
  }
  #soundGate button {
    margin-top: 14px;
    padding: 10px 18px;
    border: 0;
    border-radius: 10px;
    background: #2563eb;
    color: #fff;
    font-weight: 800;
    cursor: pointer;
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<div id="soundGate">
  <div>
    اضغط “تفعيل الصوت” مرة واحدة للسماح بالتشغيل الصوتي.<br>
    <button id="enableBtn">تفعيل الصوت</button>
  </div>
</div>

<div id="call">
  تذكرة رقم (<b id="tNum"></b>)
  <span id="wWrap" style="display:none">، الرجاء التوجه إلى شباك <b id="wNum"></b></span>
</div>

<script>
/* ========== Firebase ========== */
const cfg={
  apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
  authDomain:"q-matic-b7d77.firebaseapp.com",
  databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
  projectId:"q-matic-b7d77",
  storageBucket:"q-matic-b7d77.appspot.com",
  messagingSenderId:"908187704899",
  appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
};
firebase.initializeApp(cfg);
const db = firebase.database();
const ROOT = "cardiac_demo";

/* ========== عناصر الواجهة ========== */
const callEl = document.getElementById('call');
const tNumEl = document.getElementById('tNum');
const wWrap  = document.getElementById('wWrap');
const wNumEl = document.getElementById('wNum');

/* ========== تحويل رقم إلى كلمات عربية (موجود كما هو) ========== */
function numToArWords(n){
  n = Number(n)||0;
  if (n === 0) return "صفر";
  const u=["","واحد","اثنان","ثلاثة","أربعة","خمسة","ستة","سبعة","ثمانية","تسعة"];
  const teens=["عشرة","أحد عشر","اثنا عشر","ثلاثة عشر","أربعة عشر","خمسة عشر","ستة عشر","سبعة عشر","ثمانية عشر","تسعة عشر"];
  const t=["","","عشرون","ثلاثون","أربعون","خمسون","ستون","سبعون","ثمانون","تسعون"];
  if(n<10)return u[n];
  if(n<20)return teens[n-10];
  if(n<100){let a=n%10,b=Math.floor(n/10);return a?`${u[a]} و${t[b]}`:t[b];}
  if(n<1000){let h=Math.floor(n/100),r=n%100;return r?`${u[h]} مائة و${numToArWords(r)}`:`${u[h]} مائة`;}
  if(n<10000){let th=Math.floor(n/1000),r=n%1000;let thw=th===1?"ألف":th===2?"ألفان":`${u[th]} آلاف`;return r?`${thw} و${numToArWords(r)}`:thw;}
  return String(n).split("").map(d=>"٠١٢٣٤٥٦٧٨٩"[d]).join("");
}

/* ========== (جديد) تحويل الأرقام إلى أرقام عربية مباشرة لمنع الإعراب ========== */
function toArDigits(n){
  return String(n).replace(/\d/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
}

/* ========== إعداد الصوت (كما هو) ========== */
let ttsReady=false, lastKey="";
document.getElementById('enableBtn').onclick=()=>{
  try{ window.speechSynthesis.cancel(); }catch(e){}
  ttsReady=true;
  document.getElementById('soundGate').style.display='none';
};

function pickArabicVoice(){
  const v=window.speechSynthesis.getVoices();
  return v.find(e=>/ar|arabic/i.test(e.lang)||/arabic/i.test(e.name))||v[0];
}

function speakLoop(text,reps=2){
  if(!ttsReady)return;
  const v=pickArabicVoice();
  const say=()=>{
    const u=new SpeechSynthesisUtterance(text);
    u.lang='ar-SA';
    u.rate=1;
    u.pitch=1;
    if(v) u.voice=v;
    window.speechSynthesis.speak(u);
  };
  for(let i=0;i<reps;i++){
    setTimeout(say, i*4500);
  }
}

/* ========== (معدَّلة فقط) نداء بصيغة "رقم: ١٢" لمنع التنوين الخاطئ ========== */
function announceTicket(n,w){
  const num = toArDigits(n);
  const win = w ? toArDigits(w) : null;
  const phrase = win
    ? `تذكرة رقم: ${num}، الرجاء التوجه إلى شباك رقم: ${win}`
    : `تذكرة رقم: ${num}`;
  speakLoop(phrase, 2); // مرتين
}

/* ========== مستمع Firebase (كما هو) ========== */
db.ref(`${ROOT}/latest`).on('value',async s=>{
  const v=s&&s.val();
  if(!v||!v.number){callEl.style.display='none';return;}
  const n=v.number;

  // لا تنادي No-Show
  const ns=await db.ref(`${ROOT}/noshow/${n}`).get();
  if(ns.exists()){callEl.style.display='none';return;}

  let w=(v.window!==undefined&&v.window!==null&&v.window!=="")?v.window:null;
  if(w===null){
    const ws=await db.ref(`${ROOT}/operatorWindow`).get();
    if(ws.exists()) w=ws.val();
  }

  // عرض مرئي
  tNumEl.textContent=n;
  if(w){wNumEl.textContent=w;wWrap.style.display='inline';}
  else {wWrap.style.display='none';}
  callEl.style.display='block';

  const key=`${n}|${w||''}|${v.ts||''}`;
  if(key!==lastKey){
    lastKey=key;
    announceTicket(n,w);
  }
});
</script>
</body>
</html>
