<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cardiac Announcer</title>
<style>
  body{
    background:#f5f7fb;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:#0f172a;text-align:center;margin:0;
  }
  #call{
    display:block;width:min(960px,94vw);margin:40px auto;
    background:#000;color:#fff;border-radius:16px;
    padding:32px 18px;font-weight:800;font-size:clamp(26px,4.5vw,40px);line-height:1.6;
  }
  #soundGate{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.75);color:#fff;z-index:10;font-size:22px;
  }
  #soundGate button{
    margin-top:14px;padding:10px 18px;border:0;border-radius:10px;
    background:#2563eb;color:#fff;font-weight:800;cursor:pointer;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<div id="soundGate">
  <div>
    Ø§Ø¶ØºØ· â€œØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØªâ€ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ.<br>
    <button id="enableBtn">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
  </div>
</div>

<div id="call">
  <div>ØªØ°ÙƒØ±Ø© Ø±Ù‚Ù… (<b id="tNum">â€”</b>)</div>
  <div id="wWrap" style="display:none">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø´Ø¨Ø§Ùƒ <b id="wNum"></b></div>
</div>

<script>
const cfg={
  apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
  authDomain:"q-matic-b7d77.firebaseapp.com",
  databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
  projectId:"q-matic-b7d77",
  storageBucket:"q-matic-b7d77.appspot.com",
  messagingSenderId:"908187704899",
  appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
};
firebase.initializeApp(cfg);
const db=firebase.database();
const ROOT="cardiac_demo";

const tNumEl=document.getElementById("tNum");
const wWrap=document.getElementById("wWrap");
const wNumEl=document.getElementById("wNum");

function numToArWords(n){
  n=Number(n)||0;
  const u=["","ÙˆØ§Ø­Ø¯","Ø§Ø«Ù†Ø§Ù†","Ø«Ù„Ø§Ø«Ø©","Ø£Ø±Ø¨Ø¹Ø©","Ø®Ù…Ø³Ø©","Ø³ØªØ©","Ø³Ø¨Ø¹Ø©","Ø«Ù…Ø§Ù†ÙŠØ©","ØªØ³Ø¹Ø©"];
  const teens=["Ø¹Ø´Ø±Ø©","Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±","Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±","Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø®Ù…Ø³Ø© Ø¹Ø´Ø±","Ø³ØªØ© Ø¹Ø´Ø±","Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±","ØªØ³Ø¹Ø© Ø¹Ø´Ø±"];
  const t=["","","Ø¹Ø´Ø±ÙˆÙ†","Ø«Ù„Ø§Ø«ÙˆÙ†","Ø£Ø±Ø¨Ø¹ÙˆÙ†","Ø®Ù…Ø³ÙˆÙ†","Ø³ØªÙˆÙ†","Ø³Ø¨Ø¹ÙˆÙ†","Ø«Ù…Ø§Ù†ÙˆÙ†","ØªØ³Ø¹ÙˆÙ†"];
  if(n<10)return u[n];
  if(n<20)return teens[n-10];
  if(n<100){let a=n%10,b=Math.floor(n/10);return a?`${u[a]} Ùˆ${t[b]}`:t[b];}
  if(n<1000){let h=Math.floor(n/100),r=n%100;return r?`${u[h]} Ù…Ø§Ø¦Ø© Ùˆ${numToArWords(r)}`:`${u[h]} Ù…Ø§Ø¦Ø©`;}
  if(n<10000){let th=Math.floor(n/1000),r=n%1000;let thw=th===1?"Ø£Ù„Ù":th===2?"Ø£Ù„ÙØ§Ù†":`${u[th]} Ø¢Ù„Ø§Ù`;return r?`${thw} Ùˆ${numToArWords(r)}`:thw;}
  return String(n);
}

let ttsReady=false;
document.getElementById("enableBtn").onclick=()=>{
  try{speechSynthesis.cancel();}catch(e){}
  setTimeout(()=>speechSynthesis.getVoices(),100);
  ttsReady=true;
  document.getElementById("soundGate").style.display="none";
};

function pickArabicMaleVoice(){
  const vs=speechSynthesis.getVoices();
  if(!vs.length)return null;
  const ar=vs.filter(v=>/^ar/i.test(v.lang)||/arabic/i.test(v.name));
  const male=ar.find(v=>/(Hamed|Naayf|Zaid|Tarik|Male|Hamid)/i.test(v.name));
  return male||ar[0]||vs[0];
}

function speakTwice(text){
  if(!ttsReady)return;
  try{speechSynthesis.cancel();}catch(e){}
  const v=pickArabicMaleVoice();
  const makeU=()=>{const u=new SpeechSynthesisUtterance(text);u.lang="ar-SA";u.rate=1;u.pitch=1;if(v)u.voice=v;return u;};
  const u1=makeU(),u2=makeU();
  u1.onend=()=>speechSynthesis.speak(u2);
  speechSynthesis.speak(u1);
}

// ğŸ”¹ listener: Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ·Ø¨Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
db.ref(`${ROOT}/calls`).on("child_added",snap=>{
  const v=snap.val();
  if(!v)return;
  const n=v.number||"-";
  const w=v.window||"";
  tNumEl.textContent=n;
  if(w){wNumEl.textContent=w;wWrap.style.display="block";}else{wWrap.style.display="none";}
  const phrase=w?`ØªØ°ÙƒØ±Ø© Ø±Ù‚Ù… ${numToArWords(n)}ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø´Ø¨Ø§Ùƒ ${numToArWords(w)}.`:`ØªØ°ÙƒØ±Ø© Ø±Ù‚Ù… ${numToArWords(n)}.`;
  speakTwice(phrase);
  // Ù†Ø­Ø°Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
  setTimeout(()=>db.ref(`${ROOT}/calls/${snap.key}`).remove(),8000);
});
</script>
</body>
</html>
