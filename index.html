<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cardiac Announcer</title>
    <style>
        :root {
            --bg: #0b0e12;
            --panel: #0f1115;
            --ink: #fff;
            --muted: #9aa3af;
            --accent: #22c55e
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif
        }

        .wrap {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px
        }

        .card {
            width: min(1100px, 96vw);
            background: var(--panel);
            border-radius: 18px;
            padding: 28px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, .35);
            text-align: center
        }

        h1 {
            margin: 0 0 8px;
            font-size: clamp(22px, 3.5vw, 30px);
            color: #e5e7eb
        }

        .big {
            font-size: clamp(80px, 18vw, 200px);
            font-weight: 900;
            line-height: 1;
            margin: 8px 0;
            color: #fff
        }

        .win {
            font-size: clamp(20px, 4vw, 44px);
            font-weight: 800;
            color: var(--accent);
            margin: 6px 0 14px
        }

        .muted {
            color: var(--muted);
            font-size: 14px
        }

        .bar {
            height: 2px;
            background: #1f2937;
            margin: 14px 0 10px;
            border-radius: 2px
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 8px
        }

        input {
            background: #0b0e12;
            border: 1px solid #273244;
            color: #fff;
            padding: 10px 12px;
            border-radius: 10px;
            min-width: 160px;
            text-align: center
        }

        button {
            background: #22c55e;
            color: #0b0e12;
            border: 0;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 800;
            cursor: pointer
        }
    </style><!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1>النداء الحالي</h1>
            <div class="big" id="num">-</div>
            <div class="win" id="winText" style="display:none;"><br></div>
            <div class="bar"><br></div>
            <div class="row"><input id="winInput" placeholder="رقم الشباك" style="display:none;"> <button id="saveWin" style="display:none;">حفظ الشباك</button></div>
            <div class="muted">المنادي يعمل في الخلفية &mdash; الصوت يخرج من هذا الجهاز فقط.</div>
        </div>
    </div>
    <script>
        (function(){
          // ========= إعدادات =========
          const ROOT = new URLSearchParams(location.search).get("root") || "cardiac_demo";
        
          // Firebase
          const cfg={apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",authDomain:"q-matic-b7d77.firebaseapp.com",databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",projectId:"q-matic-b7d77",storageBucket:"q-matic-b7d77.appspot.com",messagingSenderId:"908187704899",appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"};
          firebase.initializeApp(cfg);
          const db=firebase.database();
        
          const numEl   = document.getElementById('num');
          const winText = document.getElementById('winText');
          const winInput= document.getElementById('winInput');
          const saveBtn = document.getElementById('saveWin');
        
          const ar2en = s=> String(s||"").replace(/[٠-٩]/g,d=>"٠١٢٣٤٥٦٧٨٩".indexOf(d)).replace(/[^\d]/g,"");
        
          // 1) رقم الشباك: من query ?win= أو من latest.window أو من إدخال يدوي مرّة واحدة
          const qp = new URLSearchParams(location.search);
          let windowNo = ar2en(qp.get("win") || sessionStorage.getItem("announcer-window") || "");
          function showWin(){
            if(windowNo){
              winText.style.display='block';
              winText.textContent = `الشباك ${windowNo}`;
              winInput.style.display='none';
              saveBtn.style.display='none';
              sessionStorage.setItem("announcer-window", windowNo);
            }else{
              winInput.style.display='inline-block';
              saveBtn.style.display='inline-block';
            }
          }
          saveBtn.onclick = ()=>{ windowNo = ar2en(winInput.value.trim()); showWin(); };
          showWin();
        
          // 2) نطق مرتين
          function speakTwice(n, win){
            const phrase = win ? `تذكرة رقم ${n}، الرجاء التوجه إلى شباك ${win}` : `تذكرة رقم ${n}`;
            try{ window.speechSynthesis.cancel(); }catch(e){}
            const make = ()=>{ const u=new SpeechSynthesisUtterance(phrase); u.lang="ar-SA"; u.rate=1; u.pitch=1; u.volume=1; return u; };
            window.speechSynthesis.speak(make());
            setTimeout(()=> window.speechSynthesis.speak(make()), 900);
          }
        
          // 3) متابعة النداء من الأوبريتور
          let lastNum=null, lastTs=0;
          db.ref(`${ROOT}/latest`).on("value", snap=>{
            const v = snap.val();
            if(!v || !v.number) return;
            const n = v.number;
            numEl.textContent = n;
        
            // خذ الشباك من latest أولاً، ثم من المحلي
            const w = v.window || windowNo || "";
            if(w){ windowNo = w; showWin(); }
        
            // لا نعيد نطق نفس الرقم لو لم يتغير الـ ts
            const isNew = (n!==lastNum) || (v.ts && v.ts!==lastTs);
            if(isNew){ lastNum=n; lastTs=v.ts||Date.now(); speakTwice(n, w); }
          });
        })();
    </script>

<div style="color: red">Word to HTML trial - please <a href="https://wordtohtml.net/site/payment">Go PRO</a> to get whole HTML.</div>
</body>

</html>