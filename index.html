<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cardiac Announcer</title>
<style>
  body{margin:0;background:#f5f7fb;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0f172a;text-align:center}
  #call{display:block;width:min(960px,94vw);margin:40px auto;background:#000;color:#fff;border-radius:16px;padding:32px 18px;font-weight:800;font-size:clamp(26px,4.5vw,40px);line-height:1.6}
  #call b{font-weight:800}
  #status{margin:-20px auto 24px;color:#475569;font-size:14px}
  #soundGate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.75);color:#fff;z-index:10;font-size:22px}
  #soundGate button{margin-top:14px;padding:10px 18px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:800;cursor:pointer}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

<div id="soundGate">
  <div>
    اضغط “تفعيل الصوت” مرة واحدة للسماح بالتشغيل الصوتي.<br>
    <button id="enableBtn">تفعيل الصوت</button>
  </div>
</div>

<div id="status">جاهز… بانتظار النداء التالي.</div>

<div id="call">
  تذكرة رقم (<b id="tNum">—</b>)
  <span id="wWrap" style="display:none">، الرجاء التوجه إلى شباك <b id="wNum"></b></span>
</div>

<script>
/* ========== Firebase ========== */
const cfg={
  apiKey:"AIzaSyCWWnMsge75Q3_MDF9Aj9wo4C5KD6RVGfw",
  authDomain:"q-matic-b7d77.firebaseapp.com",
  databaseURL:"https://q-matic-b7d77-default-rtdb.firebaseio.com",
  projectId:"q-matic-b7d77",
  storageBucket:"q-matic-b7d77.appspot.com",
  messagingSenderId:"908187704899",
  appId:"1:908187704899:web:b8bcf33cda90bafe81bef6"
};
firebase.initializeApp(cfg);
const db = firebase.database();
const ROOT = "cardiac_demo";

/* ========== UI refs ========== */
const callEl = document.getElementById('call');
const tNumEl = document.getElementById('tNum');
const wWrap  = document.getElementById('wWrap');
const wNumEl = document.getElementById('wNum');
const statusEl = document.getElementById('status');

/* ========== Arabic number words (no tanween) ========== */
function numToArWords(n){
  n = Number(n)||0;
  if(n===0) return "صفر";
  const u=["","واحد","اثنان","ثلاثة","أربعة","خمسة","ستة","سبعة","ثمانية","تسعة"];
  const teens=["عشرة","أحد عشر","اثنا عشر","ثلاثة عشر","أربعة عشر","خمسة عشر","ستة عشر","سبعة عشر","ثمانية عشر","تسعة عشر"];
  const t=["","","عشرون","ثلاثون","أربعون","خمسون","ستون","سبعون","ثمانون","تسعون"];
  if(n<10)  return u[n];
  if(n<20)  return teens[n-10];
  if(n<100){const a=n%10,b=(n/10)|0;return a?`${u[a]} و${t[b]}`:t[b];}
  if(n<1000){const h=(n/100)|0,r=n%100;return r?`${u[h]} مائة و${numToArWords(r)}`:`${u[h]} مائة`; }
  if(n<10000){const th=(n/1000)|0,r=n%1000;const head=th===1?"ألف":(th===2?"ألفان":`${u[th]} آلاف`);return r?`${head} و${numToArWords(r)}`:head;}
  return String(n).split("").map(d=>"٠١٢٣٤٥٦٧٨٩"[d]).join("");
}

/* ========== TTS ========== */
let ttsReady=false;
document.getElementById('enableBtn').onclick=()=>{
  try{ window.speechSynthesis.cancel(); }catch(e){}
  ttsReady=true;
  document.getElementById('soundGate').style.display='none';
};

function pickArabicVoice(){
  const vs=window.speechSynthesis.getVoices()||[];
  return vs.find(v=>/(^ar\b|arabic)/i.test(v.lang)||/arabic/i.test(v.name))||vs[0];
}

function speakTwice(text){
  if(!('speechSynthesis' in window) || !ttsReady){ return; }
  const voice = pickArabicVoice();
  const makeUtter = ()=>{ const u=new SpeechSynthesisUtterance(text); u.lang='ar-SA'; u.rate=1; u.pitch=1; if(voice) u.voice=voice; return u; };
  // مرّتين متتاليتين
  window.speechSynthesis.speak(makeUtter());
  setTimeout(()=>window.speechSynthesis.speak(makeUtter()), 3200);
}

/* ========== FIFO consumer ========== */
/* نقرأ أقدم عنصر من /calls بحسب الطابع الزمني، نعلن مرتين، ثم نحذفه */
let busy=false;

async function processNext(){
  if(busy) return;
  busy=true;
  try{
    const snap = await db.ref(`${ROOT}/calls`).orderByChild('ts').limitToFirst(1).get();
    if(!snap.exists()){ statusEl.textContent = "لا توجد نداءات حاليًا."; busy=false; return; }

    // نأخذ أول عنصر
    let firstKey=null, firstVal=null;
    snap.forEach(ch=>{ firstKey=ch.key; firstVal=ch.val(); });

    // محاولة قفل (قابلة للفشل إذا جهاز آخر أخذها)
    const lockRef = db.ref(`${ROOT}/calls/${firstKey}/lock`);
    const lockTx  = await lockRef.transaction(cur => cur ? cur : (Date.now()+":"+Math.random().toString(16).slice(2)));
    if(!lockTx.committed){ busy=false; return; } // لم نستطع القفل

    // بيانات النداء
    const n = firstVal.number;
    const w = (firstVal.window!=null && firstVal.window!=="") ? firstVal.window : null;

    // تحديث العرض
    tNumEl.textContent = n;
    if(w){ wNumEl.textContent = w; wWrap.style.display='inline'; }
    else { wWrap.style.display='none'; }
    callEl.style.display='block';
    statusEl.textContent = "جارِ النداء…";

    // جملة بدون تنوين
    const phrase = w
      ? `تذكرة رقم ${numToArWords(n)}، الرجاء التوجه إلى شباك ${numToArWords(w)}.`
      : `تذكرة رقم ${numToArWords(n)}.`;

    // نطق مرتين
    speakTwice(phrase);

    // انتظار انتهاء النداءين ثم حذف النداء والانتقال للي بعده
    setTimeout(async ()=>{
      try{ await db.ref(`${ROOT}/calls/${firstKey}`).remove(); }catch(e){}
      statusEl.textContent = "تم النداء. بانتظار التالي…";
      busy=false;
      processNext();
    }, 7000);

  }catch(e){
    statusEl.textContent = "حدث خطأ بسيط، سأحاول مجددًا…";
    busy=false;
    setTimeout(processNext, 1000);
  }
}

// استمع لأي عناصر جديدة وابدأ المعالجة إن لم تكن مشغولاً
db.ref(`${ROOT}/calls`).on('child_added', ()=>processNext());

// أيضًا جرّب تشغيل المعالجة عند البدء
processNext();
</script>
</body>
</html>
